<!DOCTYPE HTML>
<html>
	<body>
		<div style="width: 100%; height: 500px; overflow: scroll;">
		<canvas id="canvas" width="8193" height="500">
		</canvas>
		</div>
		<p id="info"></p>
		<p><input type="range" min="0" max="50" step="0.5" value="10" id="slider1" onchange="update_image()" style="width: 100%;"></p>
		<p><input type="range" min="0" max="200" step="1" value="30" id="slider2" onchange="update_image()" style="width: 100%;"></p>
		<p><input type="range" min="0" max="60000" step="250" value="0" id="slider3" onchange="update_image()" style="width: 100%;"></p>
		<input type="file" id="fileinput">
	<script type="text/javascript">
		/*
		 * Parameters
		 */
		const fftsize = 16384;
		const bins = fftsize / 2 + 1;
		const fs = 100000000.0;
		const bin_khz = fs / fftsize / 1000;

		/* Various objects */
		const reader = new FileReader();
		const canvas = document.getElementById("canvas");
		const slider1 = document.getElementById("slider1");
		const slider2 = document.getElementById("slider2");
		const slider3 = document.getElementById("slider3");
		const info = document.getElementById("info");
		const ctx = canvas.getContext("2d");
		const img = ctx.createImageData(bins, 500);
		var view = null;

		/*
		 * Precalculate color palette
		 */
		const colors = [[0,0,0], [0,0,255], [255,128,0], [255,255,255]];
		const gradientlen = 0x100;
		const palette = new Uint8Array(4 * gradientlen * (colors.length-1));
		i = 0;
		for (let c=0; c<colors.length-1; c++) {
			for(let j=0; j<gradientlen; j++) {
				const b = j / gradientlen;
				const a = 1.0 - b;
				palette[i++] = Math.round(a * colors[c][0] + b * colors[c+1][0]);
				palette[i++] = Math.round(a * colors[c][1] + b * colors[c+1][1]);
				palette[i++] = Math.round(a * colors[c][2] + b * colors[c+1][2]);
				palette[i++] = 255;
			}
		}

		/* View both the image data and the palette as Uint32Arrays
		 * so that all 4 bytes of a pixel can be copied at once
		 * and indexing becomes simpler. */
		const imgdata = new Uint32Array(img.data.buffer);
		const paldata = new Uint32Array(palette.buffer);

		function update_image() {
			if (view == null) return;
			const multiplier = slider1.value * 1;
			const offset = slider2.value * 1;
			const file_offset = Math.round(slider3.value) * bins;

			const palmax = palette.length - 1;
			const n = bins * 500;

			for (let x=0; x<n; x++) {
				let v = ((view[x + file_offset] - offset) * multiplier);
				v = Math.min(Math.max(Math.round(v), 0), palmax);
				imgdata[x] = paldata[v];
			}
			ctx.putImageData(img, 0, 0);
		}

		/*
		 * Javascript magic to load a file
		 */
		function file_loaded(ev) {
			const d = ev.target.result;
			view = new Uint8Array(d);
			update_image();
		}
		reader.addEventListener("load", file_loaded);
		function file_changed(ev) {
			reader.readAsArrayBuffer(ev.target.files[0]);
		}
		document.getElementById("fileinput").
		addEventListener("change", file_changed);

		/*
		 * Info field
		 */
		function update_info(ev) {
			info.innerText = "" + (bin_khz * ev.offsetX) + "kHz";
		}
		canvas.addEventListener("mousemove", update_info);
	</script>
	</body>
</html>
